# 音乐App自动化测试 - 梳理任务判断表

## 说明
- ✅ 表示可以实现自动化检验
- ❌ 表示不能实现自动化检验
- 判断函数栏中的 `\` 表示该任务不支持自动化验证

---

| 序号 | 任务指令 | 判断标准 | 判断函数 |
|------|---------|---------|---------|
| 1 | 打开app并进入"推荐"首页 | 检查app_state.json文件中currentPage字段是否为"recommend" | task_01_check_open_recommend_page() |
| 2 | 从"推荐"页面进入"漫游"页面 | 检查app_state.json文件中currentPage字段是否为"stroll" | task_02_check_navigate_to_stroll() |
| 3 | 从"推荐"页面进入"我的"页面 | 检查app_state.json文件中currentPage字段是否为"profile"或"my"或"mine" | task_03_check_navigate_to_profile() |
| 4 | 播放当前暂停的歌曲 | 检查playback_state.json文件中isPlaying字段是否为true | task_04_check_play_song() |
| 5 | 暂停播放当前的歌曲 | 检查playback_state.json文件中isPlaying字段是否为false | task_05_check_pause_song() |
| 6 | 切换播放上一首歌曲 | 检查playback_state.json文件中currentSong.songId字段是否发生变化(可传入期望的songId) | task_06_check_switch_previous_song(expected_song_id) |
| 7 | 将播放模式改为随机播放 | 检查playback_state.json文件中playbackMode字段是否为"shuffle" | task_07_check_shuffle_mode() |
| 8 | 收藏当前歌曲 | 检查user_favorites.json文件中favoriteSongs数组是否包含指定歌曲的songId | task_08_check_favorite_song(song_id) |
| 9 | 调节当前音乐播放的音量 | 检查playback_state.json文件中volume字段是否改变(可传入期望的音量值) | task_09_check_volume_adjusted(expected_volume) |
| 10 | 随机进入"我的"中的一个歌单 | 检查user_playlists.json文件中currentViewingPlaylist字段不为null | task_10_check_enter_playlist() |
| 11 | 进入"每日推荐"播放第三首歌曲 | 检查playback_state.json文件中currentSong.source为"daily_recommend"且sourceDetail包含"第3首" | task_11_check_daily_recommend_third_song() |
| 12 | 创建一个新的歌单,并添加首音乐 | 检查user_playlists.json文件中playlists数组是否包含指定名称的歌单,且songCount > 0 | task_12_check_create_playlist_and_add_song(playlist_name) |
| 13 | 搜索"烟雨"并播放 | 检查search_history.json文件中searches数组是否有query为"烟雨"且action为"play"的记录 | task_13_check_search_and_play(search_query) |
| 14 | 搜索某个歌手并播放其中的第一首歌 | 检查search_history.json文件中searches数组是否有resultType为"artist"且action为"play"的记录 | task_14_check_search_artist_and_play() |
| 15 | 查看一首歌曲的详细信息 | 检查app_state.json文件中currentPage为"song_detail"且currentSongId为指定歌曲ID | task_15_check_view_song_detail(song_id) |
| 16 | 查看一首歌曲的歌词 | 检查app_state.json文件中showLyrics为true或currentPage为"lyrics" | task_16_check_view_lyrics() |
| 17 | 漫游播放并设置播放场景为"伪感" | 检查player_settings.json文件中strollMode.scene字段是否为"伪感" | task_17_check_stroll_scene_setting(scene_name) |
| 18 | 打开一首歌曲的评论区并随机复制一条评论 | ❌ 无法可靠验证剪贴板内容,不支持自动化验证 | \ |
| 19 | 在排行榜中随机选择打开一个榜单并播放第一首歌曲 | 检查playback_state.json文件中currentSong.source包含"rank"或"榜单" | task_19_check_rank_list_play() |
| 20 | 在推荐歌单中随机选择一个歌单并收藏 | 检查collected_items.json文件中collectedPlaylists数组是否包含指定歌单ID | task_20_check_collect_playlist(playlist_id) |
| 21 | 删除歌单中的第一首歌 | 检查user_playlists.json文件中指定歌单的songCount是否减少到期望值 | task_21_check_delete_song_from_playlist(playlist_id, expected_count) |
| 22 | 查看每周、每月听歌时长 | 检查listening_stats.json文件中viewedStats.weekly或viewedStats.monthly字段为true | task_22_check_view_listening_stats(stat_type) |
| 23 | 分享一首歌曲到微信朋友圈 | ❌ 外部应用交互无法验证,不支持自动化验证 | \ |
| 24 | 在歌单中选择一首歌曲并发表评论 | 检查comments.json文件中userComments数组是否有对应歌曲ID的评论记录 | task_24_check_post_comment(song_id, comment_content) |
| 25 | 邀请好友一起听歌 | ❌ 多用户功能无法验证,不支持自动化验证 | \ |
| 26 | 听歌识曲(比如打开B站并识别正在播放的视频的BGM) | ❌ 跨应用功能过于复杂,不支持自动化验证 | \ |
| 27 | 更改歌单的排序顺序 | 检查user_playlists.json文件中指定歌单的sortOrder字段是否为期望值 | task_27_check_playlist_sort_order(playlist_id, expected_order) |
| 28 | 搜索一个歌手,在歌手主页选择一个专辑并收藏 | 检查collected_items.json文件中collectedAlbums数组是否包含指定专辑ID | task_28_check_collect_album(album_id) |
| 29 | 将关注列表中的一位歌手删除 | 检查followed_artists.json文件中followedArtists数组不包含指定歌手ID | task_29_check_unfollow_artist(artist_id) |
| 30 | 搜索一首歌曲并播放MV | 检查mv_playback.json文件中currentMV.mvId为指定MV且isPlaying为true | task_30_check_play_mv(mv_id) |
| 31 | 更改播放器样式 | 检查player_settings.json文件中playerStyle.styleId字段是否为指定样式ID | task_31_check_change_player_style(style_id) |

---

## 统计

- **总任务数**: 31
- **可自动化验证**: 27 (87.1%)
- **不可自动化验证**: 4 (12.9%)
  - 任务18: 复制评论(剪贴板验证困难)
  - 任务23: 分享到微信朋友圈(外部应用交互)
  - 任务25: 邀请好友(多用户功能)
  - 任务26: 听歌识曲(跨应用功能)

## 使用说明

### 1. Python脚本调用
```python
from verification_functions import *

# 示例1: 验证任务1
result = task_01_check_open_recommend_page()
print(f"任务1验证结果: {'通过' if result else '失败'}")

# 示例2: 验证任务8(需要传参)
result = task_08_check_favorite_song("song_001")
print(f"任务8验证结果: {'通过' if result else '失败'}")

# 示例3: 验证任务13(需要传参)
result = task_13_check_search_and_play("烟雨")
print(f"任务13验证结果: {'通过' if result else '失败'}")
```

### 2. 批量测试
```python
# 定义需要测试的任务
test_suite = [
    (1, "打开app并进入推荐首页", task_01_check_open_recommend_page, []),
    (4, "播放当前暂停的歌曲", task_04_check_play_song, []),
    (7, "将播放模式改为随机播放", task_07_check_shuffle_mode, []),
    (8, "收藏歌曲song_001", task_08_check_favorite_song, ["song_001"]),
]

# 执行测试
passed = 0
failed = 0
for task_id, task_name, func, args in test_suite:
    try:
        result = func(*args)
        status = "✓ 通过" if result else "✗ 失败"
        if result:
            passed += 1
        else:
            failed += 1
        print(f"任务{task_id}: {task_name} - {status}")
    except Exception as e:
        failed += 1
        print(f"任务{task_id}: {task_name} - ✗ 错误: {e}")

print(f"\n总计: {passed + failed} 个任务, {passed} 通过, {failed} 失败")
```

## 数据文件说明

| 文件名 | 作用 | 主要字段 |
|--------|------|---------|
| app_state.json | 记录当前页面和导航状态 | currentPage, navigationHistory |
| playback_state.json | 记录播放状态 | currentSong, isPlaying, playbackMode, volume |
| user_favorites.json | 记录用户收藏的歌曲 | favoriteSongs |
| user_playlists.json | 记录用户创建的歌单 | playlists, currentViewingPlaylist |
| collected_items.json | 记录收藏的歌单和专辑 | collectedPlaylists, collectedAlbums |
| followed_artists.json | 记录关注的歌手 | followedArtists |
| search_history.json | 记录搜索历史 | searches |
| comments.json | 记录用户发表的评论 | userComments |
| player_settings.json | 记录播放器设置 | playerStyle, strollMode |
| listening_stats.json | 记录听歌统计 | weeklyStats, monthlyStats, viewedStats |
| mv_playback.json | 记录MV播放状态 | currentMV, mvHistory |
| task_logs.json | 记录任务完成日志 | tasks |

## App端实现建议

为支持自动化测试,App需要在以下时机更新对应的JSON文件:

### 页面导航时
```kotlin
fun navigateToPage(pageName: String) {
    // 更新app_state.json
    updateAppState(currentPage = pageName)
}
```

### 播放控制时
```kotlin
fun playSong(songId: String) {
    // 更新playback_state.json
    updatePlaybackState(songId = songId, isPlaying = true)
}

fun pauseSong() {
    // 更新playback_state.json
    updatePlaybackState(isPlaying = false)
}

fun setPlaybackMode(mode: String) {
    // 更新playback_state.json
    updatePlaybackState(playbackMode = mode)
}
```

### 用户操作时
```kotlin
fun favoriteSong(songId: String) {
    // 更新user_favorites.json
    addToFavorites(songId)
}

fun createPlaylist(name: String, songIds: List<String>) {
    // 更新user_playlists.json
    addPlaylist(name, songIds)
}

fun collectPlaylist(playlistId: String) {
    // 更新collected_items.json
    addCollectedPlaylist(playlistId)
}
```

## 注意事项

1. **实时更新**: App必须在操作完成后立即更新对应的JSON文件
2. **数据格式**: 严格遵守JSON格式,确保能被Python正确解析
3. **时间戳**: 建议使用统一的时间格式,如"2025-11-03 10:00:00"
4. **文件路径**: 所有JSON文件必须存储在`files/autotest/`目录下
5. **错误处理**: App端应处理JSON写入失败的情况,避免影响正常功能
